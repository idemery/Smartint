window.dropbox_smartint = function () { var a = this, b = "1", c = "https://api.dropbox.com/" + b + "/", d = "https://api-content.dropbox.com/" + b + "/", f = "https://www.dropbox.com/home/Apps/MSCRMBOX", g = "l0_", h = function (a, b, c, d, e, f) { var g = { method: a, action: b, parameters: { oauth_consumer_key: e, oauth_signature_method: "HMAC-SHA1" } }, h = { consumerSecret: f }; if (d) { var i = d.split(/&/), j = {}; for (var k in i) { var l = i[k].split(/=/, 2); j[l[0]] = l[1] } g.parameters.oauth_token = j.oauth_token, h.tokenSecret = j.oauth_token_secret } if (c) for (var m in c) g.parameters[m] = c[m]; return OAuth.setTimestampAndNonce(g), OAuth.SignatureMethod.sign(g, h), g }, i = function (a) { return $.parseJSON(a.responseText) }; this.elfinder_options = null, this.nameFromPath = function (a) { return a.substr(a.lastIndexOf("/") + 1) }, this.sign_url = function (a, b, c, d) { var e = h(a, b, c, d || this.elfinder_options.data.token_data, this.elfinder_options.data.consumerKey, this.elfinder_options.data.consumerSecret), f = OAuth.getParameterMap(e.parameters); if (f) { var g = []; for (var i in f) g.push(encodeURIComponent(i) + "=" + encodeURIComponent(f[i])); f = g.length > 0 ? g.join("&").replace(/%20/g, "+") : null } return b += "?" + f }, this.getUploadUrlForIframe = function (b, c) { if (!c.files || 0 == c.files.length) return null; var e = c.files[0], f = b + "/" + e.name, f = encodeURI(f), g = d + "files_put/sandbox" + f; return g = a.sign_url("PUT", g), g += "&callback=?" }, this.getParentPath = function (a) { return a.substr(0, a.lastIndexOf("/")) }, this.encryptPath = function (a) { return a = encodeURI(a), window.base64.encode(a) }, this.decryptPath = function (a) { return decodeURI(window.base64.decode(a)) }, this.getDebug = function () { var a = { connector: "js", memory: "1344Kb / 1232Kb / 128M", mountErrors: [], time: .079999923706055, upload: "", volumes: [{ id: g, name: "localfilesystem" }] }; return a }, this.getOptions = function (a) { var b = { path: a.path, url: f + a.path, separator: "/", disabled: ["extract", "tmb", "size", "dim", "mkfile", "duplicate", "get", "put", "archive", "info", "resize", "netmount"], copyOverwrite: 1, archivers: { create: [{ 0: "application/x-tar" }, { 1: "application/x-gzip" }], extract: [{ 0: "application/x-tar" }, { 1: "application/x-gzip" }] } }; return b }, this.getCwd = function (a, b) { var c = this, d = a.contents && a.contents.length && a.contents.length > 0 ? 1 : 0, e = { name: b ? "Dropbox" : this.nameFromPath(a.path), hash: c.encryptPath(a.path), phash: c.encryptPath(c.getParentPath(a.path)), mime: a.is_dir ? "directory" : a.mime_type, ts: Math.round(+Date.parse(a.modified) / 1e3), date: a.modified, size: a.bytes, childs: d, dirs: d, tmb: a.thumb_exists ? 1 : null, read: 1, write: 1, locked: 0, volumeid: g }; return e }, this.getMetadata = function (a, b, d) { var e = c + "metadata/sandbox" + encodeURI(a); e = this.sign_url("GET", e), $.getJSON(e, b).error(d) }, this.downloadFile = function (a, b, d) { var e = c + "media/sandbox" + b; e = this.sign_url("POST", e, null, a.customData.token_data), $.ajax({ type: "POST", url: e, success: function (a) { d(a) }, dataType: "json" }) }, this.createNewFolder = function (a, b, d) { var e = c + "fileops/create_folder", f = { root: a, path: encodeURI(b) }; e = this.sign_url("POST", e, f), $.ajax({ type: "POST", url: e, data: f, success: function (a) { d(a) }, dataType: "json" }) }, this.restore = function (a, b, d, e) { var g = c + "restore", h = { root: a, path: b, rev: d }; g = this.sign_url("POST", g, h), $.ajax({ type: "POST", url: g, data: h, success: function (a) { e(a) }, dataType: "json" }) }, this.remove = function (a, b, d) { var e = c + "fileops/delete", f = { root: a, path: b }; e = this.sign_url("POST", e, f), $.ajax({ type: "POST", url: e, data: f, success: function (a) { d(a) }, dataType: "json" }) }, this.copy = function (a, b, d, e, f, g) { var h = c + "fileops/" + (e ? "move" : "copy"), k = { root: a, from_path: b, to_path: d }; h = this.sign_url("POST", h, k), $.ajax({ type: "POST", url: h, data: k, success: function (a, b, c) { 200 == c.status ? f(a) : g(i(c)) }, error: function (a) { g(i(a)) }, dataType: "json" }) }, this.shares = function (a, b, d) { var e = c + "shares/" + a + encodeURI(b); e = this.sign_url("POST", e), $.ajax({ type: "POST", url: e, success: function (a) { d(a) }, dataType: "json" }) }, this.fill_links = function (a, b, c, d, e, f, g, h) { var i = d.data.dropboxRoot, j = d.data.targets[g], k = a.decryptPath(j), l = { name: a.nameFromPath(k) }; a.shares(i, k, function (i) { l.link = i, c.push(l), g + 1 < d.data.targets.length ? h(a, b, c, d, e, f, ++g, h) : a.send_via_email(b, c, e, f) }) }, this.removefile = function (a, b, c, d, e, f, g) { var h = b.data.dropboxRoot, i = b.data.targets[e], j = a.decryptPath(i); a.remove(h, j, function () { a.remove_entry(j), f.removed.push(i), e + 1 < b.data.targets.length ? g(a, b, c, d, ++e, f, g) : c(f) }) }, this.pastefile = function (a, b, c, d, e, f, g) { var h = b.data.targets[e], i = a.decryptPath(h), k = (a.getParentPath(i), a.nameFromPath(i)), m = (a.decryptPath(b.data.src), a.decryptPath(b.data.dst)), n = m + "/" + k; a.copy(b.data.dropboxRoot, i, n, b.data.cut, function (j) { var k = a.getCwd(j); f.added.push(k), b.data.cut && (f.removed.push(h), a.remove_entry(i)), a.add_entry(n, j), e + 1 < b.data.targets.length ? g(a, b, c, d, ++e, f, g) : c(f) }, function (a) { c(a) }) }, this.convert_dropbox_response_of_uploaded_file = function (a) { var b = { added: [] }, c = JSON.parse(a), d = c.path, f = (this.getParentPath(d), this.getCwd(c)); return b.added.push(f), this.add_entry(d, c), b }, this.uploadFile = function (a, b, c, e, f, g, h, i, j) { var k = g[h], l = f + "/" + k.name, l = encodeURI(l).replace(/&/g, "%26"), m = d + "files_put/sandbox" + l; m = b.sign_url("PUT", m, null, a.customData.token_data), c.onreadystatechange = function () { if (4 == c.readyState) { var f = c.status; if (f > 500) return e.reject("errResponse"); if (200 != f) return e.reject("errConnect"); var k = JSON.parse(c.responseText), l = k.path, m = b.getParentPath(l), n = b.getCwd(k); i.added.push(n), b.add_entry(l, k), h + 1 < g.length ? j(a, b, c, e, m, g, ++h, i, j) : i.error ? e.reject(i.error) : e.resolve(i) } }, c.open("PUT", m, !0), c.send(k) }, this.set_all_entries = function (a) { localStorage.setItem("smartint_delta_entries", JSON.stringify(a)) }, this.get_delta_entries = function () { return JSON.parse(localStorage.getItem("smartint_delta_entries")) }, this.reset_all_entries = function () { localStorage.removeItem("smartint_delta_entries") }, this.add_entry = function (a, b) { var c = this.get_delta_entries(); c.push([a, b]), this.set_all_entries(c) }, this.does_entry_exist = function (a, b) { for (var d, c = b || this.get_delta_entries(), e = 0, f = c.length; f > e; e++) if (d = c[e], d[0].toUpperCase() === a.toUpperCase() && d[1]) return !0; return !1 }, this.get_entry = function (a, b) { for (var d, e, c = b || this.get_delta_entries(), f = 0, g = c.length; g > f; f++) if (e = c[f], e[0].toUpperCase() === a.toUpperCase() && e[1]) return d = e[1]; return null }, this.remove_entry = function (a) { for (var b, d, c = this.get_delta_entries(), e = 0, f = c.length; f > e; e++) if (d = c[e], d[0].toUpperCase() === a.toUpperCase()) { b = e; break } c.splice(b, 1), this.set_all_entries(c) }, this.set_delta_cursor = function (a) { localStorage.setItem("smartint_delta_cursor", a) }, this.get_delta_cursor = function () { return localStorage.getItem("smartint_delta_cursor") }, this.fill_files_in_path = function (a, b, c, d, e) { for (var f, h, g = c || this.get_delta_entries(), i = 0, j = g.length; j > i; i++) h = g[i], h[0].toUpperCase() === a.toUpperCase() && h[1] && (f = this.getCwd(h[1], b), d.push(f)), h[0].toUpperCase().indexOf(a.toUpperCase()) > -1 && h[0].split("/").length > a.split("/").length && h[1] && (e ? h[1].is_dir && d.push(this.getCwd(h[1])) : d.push(this.getCwd(h[1]))); return f }, this.init_delta = function (a, b, d) { var e = this, f = c + "delta", g = {}; f = this.sign_url("POST", f, g), $.ajax({ type: "POST", url: f, data: g, success: function (c) { c.reset && e.reset_all_entries(), e.set_delta_cursor(c.cursor), e.set_all_entries(c.entries); var h = {}, i = [], j = e.fill_files_in_path(a, b, c.entries, i); h.cwd = j, h.files = i, b && (h.uplMaxSize = "16M", h.api = "2.0"), d(h), c.has_more ? e.delta() : setTimeout(function () { e.delta() }, 3e5) }, dataType: "json" }) }, this.delta = function () { var a = this, b = c + "delta", d = a.get_delta_cursor(), e = {}; d && (e.cursor = d), b = this.sign_url("POST", b, e), $.ajax({ type: "POST", url: b, data: e, success: function (b) { if (b.reset && a.reset_all_entries(), a.set_delta_cursor(b.cursor), b.entries && b.entries.length > 0) { for (var h, e = a.get_delta_entries(), f = [], g = [], i = 0, j = b.entries.length; j > i; i++) { h = b.entries[i]; for (var l, k = !1, m = 0, n = e.length; n > m; m++) if (l = e[m], l[0].toUpperCase() === h[0].toUpperCase()) { h[1] ? e[m] = h : f.push(m), k = !k; break } !k && h[1] && g.push(h) } for (var m = 0; m < f.length; m++) e.splice(f[m], 1); for (var m = 0; m < g.length; m++) e.push(g[m]); a.set_all_entries(e); var o = window.elfinder_global_instance.cwd().hash; window.elfinder_global_instance.request({ data: { cmd: "open", target: o }, syncOnFail: !1 }) } b.has_more ? a.delta() : setTimeout(function () { a.delta() }, 3e5) }, dataType: "json" }) }, this.load_thumbnails = function (a) { for (var g, h, i, b = this, c = a.data.dropboxRoot, e = [], f = { format: "jpeg", size: "s" }, j = a.data.targets.length, k = 0; j > k; k++) { i = a.data.targets[k], h = b.decryptPath(i), g = d + "thumbnails/" + c + encodeURI(h), g = this.sign_url("GET", g, f); var l = d + "thumbnails/" + c + encodeURI(h); l = this.sign_url("GET", l, f), e.push({ hash: i, tmb: g, alt_tmb: l }) } return e }, this.send_via_email = function (a, b, c) { for (var f, e = "", g = 0; g < b.length; g++) f = b[g], e += f.name + ": " + f.link.url + " "; var m, h = {}, i = window.parent.Xrm.Page.data.entity.getEntityName(), j = window.parent.Xrm.Page.context.getQueryStringParameters().etc, k = window.parent.Xrm.Page.data.entity.getId(), l = "fullname"; "account" === i && (l = "name"), m = window.parent.Xrm.Page.getAttribute(l).getValue(), h.pId = k, h.pType = j, h.pName = m, h.partyid = k, h.partytype = j, h.partyname = m, h.subject = e, window.parent.Xrm.Utility.openEntityForm("email", null, h), c({}) } }, dropbox_smartint.prototype = { open: function (a, b) { var d = this, e = a.data.dropboxRoot, f = a.data.init && a.data.tree || a.data.init && !a.data.target ? a.data.rootTarget : this.decryptPath(a.data.target); if (a.data.init && a.data.tree) return this.getMetadata(f, function (c) { c.is_deleted ? d.createNewFolder(e, f, function () { d.init_delta(f, a.data.init, b) }) : d.init_delta(f, a.data.init, b) }, function () { d.createNewFolder(e, f, function () { d.init_delta(f, a.data.init, b) }) }), this; var g = {}, h = [], i = d.fill_files_in_path(f, !1, null, h); return g.cwd = i, g.files = h, b(g), this }, rename: function (a, b, c) { var d = this, f = d.decryptPath(a.data.target), g = d.getParentPath(f), h = g + "/" + a.data.name; return d.copy(a.data.dropboxRoot, f, h, !0, function (e) { d.remove_entry(f), d.add_entry(h, e), a.data.target = d.encryptPath(g), d.open(a, b, c) }), this }, mkdir: function (a, b) { var d = this, e = this.decryptPath(a.data.target), f = e + "/" + a.data.name, g = a.data.dropboxRoot; return this.createNewFolder(g, f, function (a) { var c = d.getCwd(a), e = { added: [c] }; d.add_entry(f, a), b(e) }), this }, paste: function (a, b, c) { var d = this, e = { added: [], removed: [] }; return d.pastefile(d, a, b, c, 0, e, d.pastefile), this }, rm: function (a, b, c) { var d = this, e = { removed: [], debug: d.getDebug() }; return d.removefile(d, a, b, c, 0, e, d.removefile), d }, tree: function (a, b) { var d = this, e = this.decryptPath(a.data.target), f = {}, g = []; return d.fill_files_in_path(e, !1, null, g, !0), f.tree = g, b(f), this }, parents: function (a, b) { var d = this, e = this.decryptPath(a.data.target), e = this.getParentPath(e), f = {}, g = []; return d.fill_files_in_path(e, !1, null, g, !0), f.tree = g, b(f), this }, ls: function (a, b) { var e = this.decryptPath(a.data.target), f = []; this.fill_files_in_path(e, !1, null, f); var h = { list: f }; return b(h), this }, file: function (a, b) { var c, d, e, f; for (c = 0, d = b.length; d > c; c++) e = b[c].hash, f = this.decryptPath(e), f = encodeURI(f), this.downloadFile(a, f, function (a) { console.log(a), window.open(a.url, "_blank"), window.focus() }); return this }, tmb: function (a, b) { var d = this, f = (a.data.dropboxRoot, {}); return f.images = d.load_thumbnails(a), b(f), this }, sim: function (a, b, c) { var h, d = this, e = a.data.targets, f = d.decryptPath(e[0]), i = (d.get_entry(f), []); if (1 == e.length) h = d.nameFromPath(f); else { var j = d.getParentPath(f); h = d.nameFromPath(j) } d.fill_links(d, h, i, a, b, c, 0, d.fill_links) }, request: function (a, b, c) { return this.elfinder_options = a, this[a.data.cmd](a, b, c), this } };