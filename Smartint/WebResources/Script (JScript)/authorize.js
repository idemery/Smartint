function activation_successful(a) { $("#reload-button").data("license", a); var b = sign_url("POST", "https://api.dropbox.com/1/oauth/request_token"); $.post(b, function (a) { var d = a.split(/&/), e = {}; for (var f in d) { var g = d[f].split(/=/, 2); e[g[0]] = g[1] } $("#reload-button").show(), $("#reload-button").data("request_token", e) }), $("#reload-button").click(function () { var a = $("#reload-button").data("request_token"), b = $(this).data("authorize"); if (b) { var d = sign_url("POST", "https://api.dropbox.com/1/oauth/access_token", null, a); $.post(d, function (a) { var d = a.split(/&/), e = {}; for (var f in d) { var g = d[f].split(/=/, 2); e[g[0]] = g[1] } $("#reload-button").data("access_token", e); var h = $("#reload-button").data("license"); create_settings(a, h) }), $(this).data("authorize", !1), $(this).text("Authorize") } else { var c = "https://www.dropbox.com/1/oauth/authorize?oauth_token=" + a.oauth_token; window.open(c, "_blank"), $(this).text("I have authorized Smartint!"), $(this).data("authorize", !0) } }) } function create_settings(a, b) { try { var c = { qg_token: a, qg_License: b, qg_DisableLeftNavigationPanel: !1, qg_FieldOfFolderName: !1 }, d = "qg_smartintsettings", e = window.parent.Xrm.Page.context.getClientUrl(), f = e + "/XRMServices/2011/OrganizationData.svc/" + d + "Set"; $.ajax({ type: "POST", contentType: "application/json; charset=utf-8", datatype: "json", url: f, data: JSON.stringify(c), beforeSend: function (a) { a.setRequestHeader("Accept", "application/json") }, success: function () { alert("Settings have been saved successfully.") }, error: function (b, c, d) { alert("Error on the creation of settings; Error \u2013 " + d), prompt("Access Token: Please save the following data", a) } }) } catch (g) { prompt("Access Token: Please save the following data", a) } } function retrieveEntities() { SDK.Metadata.RetrieveAllEntities(SDK.Metadata.EntityFilters.Entity, !0, function (a) { var b = $.grep(a, function (a) { return 0 == a.IsActivity && 1 == a.IsCustomizable.Value && 1 == a.IsRenameable.Value && 1 == a.CanBePrimaryEntityInRelationship.Value && 1 == a.CanBeRelatedEntityInRelationship.Value && 1 == a.CanBeInManyToMany.Value && 1 == a.CanCreateAttributes.Value && 1 == a.CanCreateCharts.Value && 1 == a.CanCreateForms.Value && 1 == a.CanCreateViews.Value && 1 == a.CanModifyAdditionalSettings.Value && a.DisplayCollectionName && a.DisplayCollectionName.UserLocalizedLabel }); b.sort(SortByName), getAllEntitiesEnabledForSmartint(function (a) { for (var c = [], d = 0; d < b.length; d++) { var e = {}; e.Metadata = b[d], e.SmartintIsEnabled = !1; for (var f = 0; f < a.length; f++) a[f].qg_EntityLogicalName == b[d].LogicalName && (e.SmartintIsEnabled = !0); c.push(e) } $.tmpl('<div class="row" style="padding-top:10px;"><div class="col-lg-12"><div class="input-group"><span class="input-group-addon"><input class="entity-check-box" type="checkbox" data-etn="${Metadata.LogicalName}" data-display-name="${Metadata.DisplayCollectionName.UserLocalizedLabel.Label}" {{if SmartintIsEnabled == true}} checked {{/if}}></span><span class="input-group-addon" style="border-right-width: 0px;"><img class="entity-icon" data-etc="${Metadata.ObjectTypeCode}" data-is-custom="${Metadata.IsCustomEntity}" data-icon-url="${Metadata.IconSmallName}" data-progress-icon-url="../webresources/qg_/img/spinnermini.gif" alt="" src="../webresources/qg_/img/spinnermini.gif"></span><span class="form-control" style="text-align: left;">${Metadata.DisplayCollectionName.UserLocalizedLabel.Label}</span></div></div></div>', c).appendTo("#entities-container"), loadIcons() }) }, function (a) { alert("error"), console.log(a) }, null) } function loadIcons() { $(".entity-icon").each(function () { loadIconForImg(this) }) } function loadIconForImg(a) { var b = $(a).data("etc"); a.src = $(a).data("is-custom") ? $(a).data("icon-url") ? $(a).data("icon-url") : window.parent.Xrm.Page.context.getClientUrl() + GetIconUrl(b) : GetIconUrl(b) } function GetIconUrl(a) { var b; return b = 4710 == a || 9600 == a || 4005 == a ? "/_imgs/ico_16_" + a + ".png" : a >= 1e4 ? "/_Common/icon.aspx?objectTypeCode=" + a + "&iconType=GridIcon&cache=1" : "/_imgs/ico_16_" + a + ".gif" } function SortByName(a, b) { var c = a.DisplayCollectionName.UserLocalizedLabel.Label.toLowerCase(), d = b.DisplayCollectionName.UserLocalizedLabel.Label.toLowerCase(); return d > c ? -1 : c > d ? 1 : 0 } function enableSmartintForEntity(a, b, c, d) { var e = { qg_name: a, qg_EntityLogicalName: b, qg_FormName: "", qg_UseCustomForm: !1 }, f = "qg_smartintforentity", g = window.parent.Xrm.Page.context.getClientUrl(), h = g + "/XRMServices/2011/OrganizationData.svc/" + f + "Set"; $.ajax({ type: "POST", contentType: "application/json; charset=utf-8", datatype: "json", url: h, data: JSON.stringify(e), beforeSend: function (a) { a.setRequestHeader("Accept", "application/json") }, success: function (a) { c(a) }, error: function (a, b, c) { d(a, c) } }) } function disableSmartintForEntity(a, b, c) { var f, d = "qg_smartintforentity", e = "?$select=qg_smartintforentityId&$filter=qg_EntityLogicalName eq '" + a + "'", g = window.parent.Xrm.Page.context.getClientUrl(); f = g + "/XRMServices/2011/OrganizationData.svc/" + d + "Set" + e, $.ajax({ type: "GET", contentType: "application/json; charset=utf-8", datatype: "json", url: f, beforeSend: function (a) { a.setRequestHeader("Accept", "application/json") }, success: function (a) { for (var f = a.d.results, g = 0; g < f.length; g++) { var h = f[g], i = h.qg_smartintforentityId; 0 == g ? deleteSmartintForEntity(i, b, c) : deleteSmartintForEntity(i) } }, error: function (a, b, d) { alert("Status: " + b + "; ErrorThrown: " + d), console.log(a), c(a, d) } }) } function deleteSmartintForEntity(a, b, c) { var e, d = "qg_smartintforentity", f = window.parent.Xrm.Page.context.getClientUrl(); e = f + "/XRMServices/2011/OrganizationData.svc/" + d + "Set", $.ajax({ type: "POST", contentType: "application/json; charset=utf-8", datatype: "json", url: e + "(guid'" + a + "')", beforeSend: function (a) { a.setRequestHeader("Accept", "application/json"), a.setRequestHeader("X-HTTP-Method", "DELETE") }, success: function (a) { b && b(a) }, error: function (a, b, d) { c && c(a, d) } }) } function getAllEntitiesEnabledForSmartint(a) { var d, b = "qg_smartintforentity", c = "?$select=qg_smartintforentityId,qg_EntityLogicalName", e = window.parent.Xrm.Page.context.getClientUrl(); d = e + "/XRMServices/2011/OrganizationData.svc/" + b + "Set" + c, $.ajax({ type: "GET", contentType: "application/json; charset=utf-8", datatype: "json", url: d, beforeSend: function (a) { a.setRequestHeader("Accept", "application/json") }, success: function (b) { var e = b.d.results; a(e) }, error: function (a, b, c) { alert("Status: " + b + "; ErrorThrown: " + c), console.log(a) } }) } var consumerKey, consumerSecret, auth_msg = function (a, b, c, d) { var e = { method: a, action: b, parameters: { oauth_consumer_key: consumerKey, oauth_signature_method: "HMAC-SHA1" } }, f = { consumerSecret: consumerSecret }; if (d && (e.parameters.oauth_token = d.oauth_token, f.tokenSecret = d.oauth_token_secret), c) for (var g in c) e.parameters[g] = c[g]; return OAuth.setTimestampAndNonce(e), OAuth.SignatureMethod.sign(e, f), e }, sign_url = function (a, b, c, d) { var e = auth_msg(a, b, c, d), f = OAuth.getParameterMap(e.parameters); if (f) { var g = []; for (var h in f) g.push(encodeURIComponent(h) + "=" + encodeURIComponent(f[h])); f = g.length > 0 ? g.join("&").replace(/%20/g, "+") : null } return b += "?" + f }; $(function () { retrieveEntities(); var a = prompt("Please enter your license key to activate Smartint, or ignore this message if Smartint has been already activated."); a && null != a && $.getJSON("http://quitegeek.com/?edd_action=activate_license&item_name=Smartint%202&license=" + a + "&url=" + window.location.origin, function (b) { return b ? ("valid" == b.license ? (consumerKey = b.consumer_key, consumerSecret = b.consumer_secret, alert("Congratulations! Smartint has been activated successfully for customer: " + b.customer_name), activation_successful(a)) : alert("The license provided is invalid. If you believe that your license is valid, please contact our support."), void 0) : (alert("Error activating Smartint, Please contact our support."), void 0) }) }), $(function () { $(document).on("change", ".entity-check-box", function () { var c = $(this).data("display-name"), d = $(this).data("etn"), e = this.checked, f = $(this).closest(".row").find("img").get(0), g = $(f).data("progress-icon-url"); f.src = g, e ? enableSmartintForEntity(c, d, function () { loadIconForImg(f) }, function (a, b) { loadIconForImg(f); try { alert(JSON.parse(a.responseText).error.message.value) } catch (d) { } console.log("Error Enabling entity: " + c), console.log(a), console.log(b) }) : disableSmartintForEntity(d, function () { loadIconForImg(f) }, function (a, b) { loadIconForImg(f); try { alert(JSON.parse(a.responseText).error.message.value) } catch (d) { } console.log("Error Enabling entity: " + c), console.log(a), console.log(b) }) }) });